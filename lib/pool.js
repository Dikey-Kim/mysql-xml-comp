var mysql=require("mysql"),Pool=require("mysql/lib/Pool"),Sequence=require("mysql/lib/protocol/sequences/Sequence"),Query=require("mysql/lib/protocol/sequences/Query"),Promise=require("promise"),xmlLoader=require("./xml-loader"),extractor=require("./json-extractor"),queryFormat=require("./query-format");Sequence.prototype.__end=Sequence.prototype.end;
Sequence.prototype.end=function(a){this instanceof Query&&Array.isArray(arguments[1])&&(arguments[1]=extractor(arguments[1]));Sequence.prototype.__end.apply(this,arguments)};var dynamicQuery=function(a,c){return function(b,e){e||(e=b,b=[]);c.query(a,b,function(a,d,b){e(a,d,b)})}};
Pool.prototype.setXmlMapper=function(a,c){var b=this;this.logging("[MySQL-Init]Directory Read:",a);xmlLoader(a,function(a,f){if(a)return c(a);if(f.query)for(var d in f.query)f.query.hasOwnProperty(d)&&(b.logging("[MySQL-Init]Dynamic Query Added : "+d),b[d]=dynamicQuery(f.query[d],b));c(null)})};
Pool.prototype.proc=function(a,c,b){this.getConnection(function(e,f){var d="call "+a+"(",g=0;if(e)return b(e);for(;g<c.length;g++)d+="?, ";d=d.substring(0,d.length-2)+")";f.query(d,c,function(a,d,c){try{f.release()}catch(h){}if(a)return b(a);b(null,d,c)})})};Pool.prototype.exec=function(a,c){var b=this;return new Promise(function(e,f){b.proc(a,c,function(a,b,c){if(a)return f(a);e(b)})})};
Pool.prototype.promiseQuery=function(a,c){var b=this;return new Promise(function(c,f){b.getConnection(function(b,e){e.query(a,function(a,b,d){try{e.release()}catch(h){}if(a)return f(a);c(b)})})})};module.exports=Pool;module.exports.createPool=function(a){a.queryFormat=queryFormat;var c=mysql.createPool(a);"function"===typeof a.logger?(c.logging=a.logger,xmlLoader.setLogger(a.logger),queryFormat.setLogger(a.logger)):c.logging=function(){};return c};
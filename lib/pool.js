var mysql=require("mysql"),Pool=require("mysql/lib/Pool"),Sequence=require("mysql/lib/protocol/sequences/Sequence"),Query=require("mysql/lib/protocol/sequences/Query"),Promise=require("promise"),xmlLoader=require("./xml-loader"),extractor=require("./json-extractor"),queryFormat=require("./query-format");Sequence.prototype.__end=Sequence.prototype.end;
Sequence.prototype.end=function(a){this instanceof Query&&Array.isArray(arguments[1])&&(arguments[1]=extractor(arguments[1]));Sequence.prototype.__end.apply(this,arguments)};var dynamicQuery=function(a,b){return function(c,f){f||(f=c,c=[]);b.query(a,c,function(a,d,b){f(a,d,b)})}};
Pool.prototype.setXmlMapper=function(a,b){var c=this;this.logging("[MySQL-Init]Directory Read:",a);xmlLoader(a,function(a,e){if(a)return b(a);if(e.query)for(var d in e.query)e.query.hasOwnProperty(d)&&(c.logging("[MySQL-Init]Dynamic Query Added : "+d),c[d]=dynamicQuery(e.query[d],c));b(null)})};
Pool.prototype.proc=function(a,b,c){this.getConnection(function(f,e){var d="call "+a+"(",g=0;if(f)return c(f);for(;g<b.length;g++)d+="?, ";d=d.substring(0,d.length-2)+")";e.query(d,b,function(a,b,d){try{e.release()}catch(h){}if(a)return c(a);c(null,b,d)})})};Pool.prototype.exec=function(a,b){var c=this;return new Promise(function(f,e){c.proc(a,b,function(a,b,c){if(a)return e(a);f(b)})})};module.exports=Pool;
module.exports.createPool=function(a){a.queryFormat=queryFormat;var b=mysql.createPool(a);"function"===typeof a.logger?(b.logging=a.logger,xmlLoader.setLogger(a.logger),queryFormat.setLogger(a.logger)):b.logging=function(){};return b};